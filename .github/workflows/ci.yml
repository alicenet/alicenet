name: Alicenet CI

on:
    workflow_dispatch:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

env:
    NODE_VERSION: 16.x
    DKG_TESTS_PATH: github.com/alicenet/alicenet/layer1/executor/tasks/dkg/tests

concurrency:
    group: ${{ github.ref }}
    cancel-in-progress: true

defaults:
    run:
        shell: bash

jobs:
    solidity-build:
        runs-on: ubuntu-20.04
        timeout-minutes: 10
        defaults:
            run:
                working-directory: ./bridge
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/node-cache

    solidity-unit-tests:
        runs-on: ubuntu-20.04
        timeout-minutes: 15
        strategy:
            matrix:
                include:
                    - test-group: "[0-9a-dA-D]"
                    - test-group: "[eE]"
                      sub-filter-exclude: "ethdkg/phases"
                    - test-group: "ethdkg"
                      sub-filter-include: "phases"
                      sub-filter-exclude: "accusations"
                    - test-group: "ethdkg"
                      sub-filter-include: "phases/accusations"
                    - test-group: "[f-qF-Q]"
                    - test-group: "[r-sR-S]"
                    - test-group: "[t-zT-Z]"
        needs: solidity-build
        defaults:
            run:
                working-directory: ./bridge
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/node-cache
            - uses: ./.github/actions/solidity-tests
              with:
                  test-group: ${{ matrix.test-group }}
                  sub-filter-include: ${{ matrix.sub-filter-include }}
                  sub-filter-exclude: ${{ matrix.sub-filter-exclude }}

    solidity-linter:
        runs-on: ubuntu-20.04
        timeout-minutes: 10
        needs: solidity-build
        defaults:
            run:
                working-directory: ./bridge
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/node-cache
            - run: npm run lint-solidity

    typescript-linter:
        runs-on: ubuntu-20.04
        timeout-minutes: 10
        needs: solidity-build
        defaults:
            run:
                working-directory: ./bridge
                shell: bash
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/node-cache
            - run: npm run clean && npm run compile && npm run typechain
            - run: npm run lint

    golang-linter:
        runs-on: ubuntu-20.04
        timeout-minutes: 10
        continue-on-error: true
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/alicenet-config
            - uses: golangci/golangci-lint-action@v3

    golang-unit-tests:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ ubuntu-20.04 ]
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/alicenet-config
            - run: go build ./...
            - name: Set up gotestfmt
              run: go install github.com/haveyoudebuggedit/gotestfmt/v2/cmd/gotestfmt@latest
            - name: Run unit tests
              timeout-minutes: 20
              run: |
                  set -euo pipefail
                  go test -json -timeout=20m -covermode=atomic -coverprofile=coverage.out `go list ./... | grep -v $DKG_TESTS_PATH` 2>&1 | tee /tmp/gotest.log | gotestfmt
            - uses: codecov/codecov-action@v3
              with:
                  files: ./coverage.out
                  verbose: true

    golang-dkg-tests:
        runs-on: ${{ matrix.os }}
        timeout-minutes: 60
        strategy:
            fail-fast: false
            matrix:
                os: [ ubuntu-20.04 ]
                test-groups: [
                   TestShareDistribution_Group_1,
                   TestShareDistribution_Group_2,
                   TestShareDistribution_Group_3,
                   TestRegisterTask_Group_1,
                   TestRegisterTask_Group_2,
                   TestRegisterTask_Group_3,
                   TestMPKSubmission_Group_1,
                   TestMPKSubmission_Group_2,
                   TestKeyShareSubmission,
                   TestGPKjSubmission_Group_1,
                   TestGPKjSubmission_Group_2,
                   TestDisputeShareDistributionTask_Group_1,
                   TestDisputeShareDistributionTask_Group_2,
                   TestDisputeMissingShareDistributionTask_Group_1,
                   TestDisputeMissingShareDistributionTask_Group_2,
                   TestDisputeMissingRegistrationTask_Group_1,
                   TestDisputeMissingRegistrationTask_Group_2,
                   TestDisputeMissingKeySharesTask,
                   TestDisputeMissingGPKjTask_Group_1,
                   TestDisputeMissingGPKjTask_Group_2,
                   TestGPKjDispute,
                   TestCompletion_Group_1,
                   TestCompletion_Group_2,
                   TestCompletion_Group_3,
                ]
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/alicenet-config
            - run: go build ./...
            - name: Set up gotestfmt
              run: go install github.com/haveyoudebuggedit/gotestfmt/v2/cmd/gotestfmt@latest
            - name: Run tests ${{ matrix.test-groups }}
              timeout-minutes: 20
              run: |
                  go test -tags=integration -json -timeout=15m $DKG_TESTS_PATH -run ${{ matrix.test-groups }} 2>&1 | tee /tmp/gotest.log | gotestfmt
