import { keccak256 } from "ethers/lib/utils";
import fs from "fs/promises";
import path from "path";

const bindingsDir = path.resolve(__dirname, "../../bindings");
const abiDir = path.resolve(bindingsDir, "bindings-artifacts");

type signatureAssociation = { signature: Buffer; name: string };

async function generateMappingFile() {
  console.log("generating signature mapping...");

  const files = (await fs.readdir(abiDir)).filter((file) =>
    file.endsWith(".json")
  );

  const associations: signatureAssociation[] = (
    await Promise.all(
      files.map(async (fileName) => {
        const contents = await fs.readFile(path.resolve(abiDir, fileName));

        const abi = JSON.parse(contents.toString());
        const contractName = path.basename(fileName, ".json");

        return abi
          .filter((x: any) => x.type === "function")
          .map((func: any) => {
            const canonical = `${func.name}(${func.inputs
              .map((input: any) => input.type)
              .join(",")})`;

            return {
              signature: Buffer.from(
                keccak256(Buffer.from(canonical)).slice(2, 10),
                "hex"
              ),
              name: `${contractName}.${canonical}`,
            };
          });
      })
    )
  ).flat();

  const golangSrc = `// Generated by custom bridge script. DO NOT EDIT.

package bindings

var FunctionMapping = map[[4]byte]string {
    {0,0,0,0}: "transfer()",
    {96,128,96,64}: "deploy()",
${associations
      .map(({ name, signature }) => `\t{${signature.join(",")}}: "${name}"`)
      .join(",\n")}}
`;

  await fs.mkdir(bindingsDir, { recursive: true });
  await fs.writeFile(path.resolve(bindingsDir, "mapping.go"), golangSrc);
}

async function main() {
  await generateMappingFile();
}
main().finally(() => { });
